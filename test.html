<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Fiche INFRA – Export Essieux</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://unpkg.com/html5-qrcode"></script>

<style>
body { font-family: Arial, sans-serif; padding: 20px; }
button { padding: 10px 15px; margin: 5px; font-size: 1rem; }
#reader { width: 300px; margin-bottom: 20px; }
table { margin-top: 20px; border-collapse: collapse; width: 100%; }
table, th, td { border: 1px solid black; }
th, td { padding: 6px; text-align: center; }
</style>
</head>

<body>

<h2>Fiche INFRA – Scan Essieux</h2>

<div id="reader"></div>

<label>Numéro de wagon :</label><br>
<input id="wagon-number" type="text" placeholder="12 34 5678 901-2"
       style="padding:6px; width:220px;"><br><br>

<button id="scan-btn" onclick="startScan()">Scanner</button>

<button onclick="exportExcel()">Exporter vers Excel</button>

<table id="table-essieux">
<thead>
<tr>
<th>Essieu</th><th>SN</th><th>Type</th><th>Tonnage</th><th>Détenteur</th><th>Révision</th><th>Atelier</th>
</tr>
</thead>
<tbody>
<tr><td>1</td><td colspan="6">En attente…</td></tr>
<tr><td>2</td><td colspan="6">En attente…</td></tr>
<tr><td>3</td><td colspan="6">En attente…</td></tr>
<tr><td>4</td><td colspan="6">En attente…</td></tr>
</tbody>
</table>

<script>
let essieux = [null, null, null, null];
let currentScanner = null;
let nextIndex = 0;

function parseQR(text) {
    const parts = text.split(";");
    let data = {};
    parts.forEach(p => {
        const [k, v] = p.split("=");
        if (k && v) data[k.trim().toLowerCase()] = v.trim();
    });
    return {
        sn: data.sn || "",
        type: data.type || "",
        tonnage: data.tonnage || "",
        owner: data.owner || "",
        rev: data.rev || "",
        atelier: data.atelier || ""
    };
}

function updateTable() {
    const tbody = document.querySelector("#table-essieux tbody");
    tbody.innerHTML = "";
    for (let i = 0; i < 4; i++) {
        const e = essieux[i];
        if (!e) {
            tbody.innerHTML += `<tr><td>${i+1}</td><td colspan="6">En attente…</td></tr>`;
        } else {
            tbody.innerHTML += `
            <tr>
                <td>${i+1}</td>
                <td>${e.sn}</td>
                <td>${e.type}</td>
                <td>${e.tonnage}</td>
                <td>${e.owner}</td>
                <td>${e.rev}</td>
                <td>${e.atelier}</td>
            </tr>`;
        }
    }
}

async function startScan() {

    if (nextIndex >= 4) {
        alert("Tous les essieux sont scannés");
        document.getElementById("scan-btn").disabled = true;
        return;
    }

    if (currentScanner) {
        try { await currentScanner.stop(); } catch(e){}
        try { await currentScanner.clear(); } catch(e){}
        currentScanner = null;
    }

    currentScanner = new Html5Qrcode("reader");

    currentScanner.start(
        { facingMode: "environment" },
        { fps: 10, qrbox: 250 },
        async qrText => {

            essieux[nextIndex] = parseQR(qrText);
            updateTable();
            nextIndex++;

            try { await currentScanner.stop(); } catch(e){}
            try { await currentScanner.clear(); } catch(e){}
            currentScanner = null;

            if (nextIndex >= 4) {
                document.getElementById("scan-btn").disabled = true;
                alert("Tous les essieux sont scannés");
            }
        }
    );
}

async function exportExcel() {
    const wagon = document.getElementById("wagon-number").value.trim();
    if (!wagon) { alert("Numéro de wagon manquant"); return; }

    const url = "https://github.com/macflyer057-coder/Inventaire/raw/refs/heads/main/Test_fiche_INFRA_.xlsx";
    const response = await fetch(url);
    const arrayBuffer = await response.arrayBuffer();
    const workbook = XLSX.read(arrayBuffer, { type: "array" });

    const sheet = workbook.Sheets["VPI04AN26-2 4 Essieux"];

    const mapping = [
        ["H14","H15","I15","H16","H17","H18"],
        ["J14","J15","K15","J16","J17","J18"],
        ["L14","L15","M15","L16","L17","L18"],
        ["N14","N15","O15","N16","N17","N18"]
    ];

    for (let i = 0; i < 4; i++) {
        if (essieux[i]) {
            const e = essieux[i];
            const c = mapping[i];
            sheet[c[0]] = { v: e.sn };
            sheet[c[1]] = { v: e.type };
            sheet[c[2]] = { v: e.tonnage };
            sheet[c[3]] = { v: e.owner };
            sheet[c[4]] = { v: e.rev };
            sheet[c[5]] = { v: e.atelier };
        }
    }

    const wbout = XLSX.write(workbook, { bookType: "xlsx", type: "array" });
    const blob = new Blob([wbout], { type: "application/octet-stream" });
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = `Fiche INFRA wagon ${wagon}.xlsx`;
    link.click();
}
</script>

</body>
</html>
